<!DOCTYPE html>

<html lang="fr" data-content_root="./">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>Mise en production &#8212; Documentation orange_county 0.1</title>
    <link rel="stylesheet" type="text/css" href="_static/pygments.css?v=d1102ebc" />
    <link rel="stylesheet" type="text/css" href="_static/alabaster.css?v=12dfc556" />
    <link rel="stylesheet" type="text/css" href="_static/graphviz.css?v=eafc0fe6" />
    <script src="_static/documentation_options.js?v=af8511e3"></script>
    <script src="_static/doctools.js?v=888ff710"></script>
    <script src="_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="_static/translations.js?v=d99ca74e"></script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Recherche" href="search.html" />
    <link rel="next" title="Interface de programmation" href="api_description.html" />
    <link rel="prev" title="Gestion des données" href="data_management.html" />
   
  <link rel="stylesheet" href="_static/custom.css" type="text/css" />
  

  
  

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <section id="mise-en-production">
<h1>Mise en production<a class="headerlink" href="#mise-en-production" title="Link to this heading">¶</a></h1>
<section id="flux-de-travail">
<h2>flux de travail<a class="headerlink" href="#flux-de-travail" title="Link to this heading">¶</a></h2>
<ol class="arabic simple">
<li><p>Modification du code source</p></li>
<li><p>Commit des changements vers le repertoire distant</p></li>
<li><p>Déclanchement automatique de la routine CircleCI</p></li>
<li><p>Lancement de la suite de test</p></li>
<li><p>Lancement du test de couverture du code</p></li>
<li><p>Lancement du test de Linting</p></li>
<li><p>Les résultats du test de Linting et de courverture ne sont pas blocant</p></li>
<li><p>Si la suite de test se termine avec succés, circleCI à la création du conteneur Docker</p></li>
<li><p>Aprés avoir reçu un tag unique, l’image est envoyé sur dockerHub</p></li>
<li><p>La réception d’une nouvelle image sur dockerHub déclanche la routina par Render</p></li>
<li><p>Render, au signal d’une nouvelle image, va récupérer celle-ci.</p></li>
<li><p>Lancer une série de commande pour lancer le conteneur, distribuer les fichiers statiques et lancer le serveur Django</p></li>
</ol>
</section>
<section id="gestion-du-deploiement">
<h2>Gestion du deploiement<a class="headerlink" href="#gestion-du-deploiement" title="Link to this heading">¶</a></h2>
<section id="configuration-du-fichier-config-yml">
<h3>Configuration du fichier config.yml<a class="headerlink" href="#configuration-du-fichier-config-yml" title="Link to this heading">¶</a></h3>
<p>Le fichier <cite>.circleci/config.yml</cite> permet de configurer une série de tâche. Par défaut, ces tâches sont excécutées dans leurs ordres de définitions. Il est possible de créer des workflows pour définir un flux personnalisé selon les besoins.</p>
<p>Exemple de configuration pour la réalisation des tests unitaire
* selectionner une image docker depuis circleCI</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">docker</span><span class="p">:</span>
 <span class="o">-</span> <span class="n">image</span><span class="p">:</span> <span class="n">cimg</span><span class="o">/</span><span class="n">python</span><span class="p">:</span><span class="mf">3.10</span>
</pre></div>
</div>
<ul class="simple">
<li><p>charger les variables d’environnement. Dans notre cas, on défini la variable ALLOWED_HOSTS pour django</p></li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">environment</span><span class="p">:</span>
 <span class="o">-</span> <span class="n">ALLOWED_HOSTS</span><span class="p">:</span> <span class="n">localhost</span>
</pre></div>
</div>
<ul>
<li><dl>
<dt>On viens définir ensuite les étapes de notre taches</dt><dd><ul class="simple">
<li><p>récupération du code depuis github</p></li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">-</span> <span class="n">checkout</span>
</pre></div>
</div>
<ul class="simple">
<li><p>circleCI va chercher à restorer un cache ayant un tag unique composé du nom de la branche et du checksum basé sur requirements.txt</p></li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">-</span> <span class="n">restore_cache</span><span class="p">:</span>
    <span class="n">key</span><span class="p">:</span> <span class="n">deps1</span><span class="o">-</span><span class="p">{{</span> <span class="o">.</span><span class="n">Branch</span> <span class="p">}}</span><span class="o">-</span><span class="p">{{</span> <span class="n">checksum</span> <span class="s2">&quot;requirements.txt&quot;</span> <span class="p">}}</span>
</pre></div>
</div>
<ul class="simple">
<li><p>La suite des instructions permet de créer un environment virtuel, son exécecution et l’installation des librairies. Si un fichier de cache existe, les instructions seront évalué mais les actions sont déjà réalisées.</p></li>
</ul>
<blockquote>
<div><div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">python3</span> <span class="o">-</span><span class="n">m</span> <span class="n">venv</span> <span class="n">venv</span>
<span class="o">.</span> <span class="n">venv</span><span class="o">/</span><span class="nb">bin</span><span class="o">/</span><span class="n">activate</span>
<span class="n">pip</span> <span class="n">install</span> <span class="o">-</span><span class="n">U</span> <span class="n">pip</span> <span class="n">setuptools</span>
<span class="n">pip</span> <span class="n">install</span> <span class="o">-</span><span class="n">r</span> <span class="n">requirements</span><span class="o">.</span><span class="n">txt</span>
</pre></div>
</div>
</div></blockquote>
<ul>
<li><p>on créer un cache pour faciliter la prochaine exécution.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">key</span><span class="p">:</span> <span class="n">deps1</span><span class="o">-</span><span class="p">{{</span> <span class="o">.</span><span class="n">Branch</span> <span class="p">}}</span><span class="o">-</span><span class="p">{{</span> <span class="n">checksum</span> <span class="s2">&quot;requirements.txt&quot;</span> <span class="p">}}</span>
 <span class="n">paths</span><span class="p">:</span>
  <span class="o">-</span> <span class="s2">&quot;venv&quot;</span>
</pre></div>
</div>
</li>
<li><p>Enfin on excécute la commande d’interêt. Dans ce cas, on active l’environment virtuel et on exécute le module pytest</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">name</span><span class="p">:</span> <span class="n">Running</span> <span class="n">tests</span>
<span class="n">command</span><span class="p">:</span> <span class="o">|</span>
  <span class="o">.</span> <span class="n">venv</span><span class="o">/</span><span class="nb">bin</span><span class="o">/</span><span class="n">activate</span>
  <span class="n">python3</span> <span class="o">-</span><span class="n">m</span> <span class="n">pytest</span>
</pre></div>
</div>
</li>
</ul>
</dd>
</dl>
</li>
</ul>
<p>on attribut un nom de workflow au sommet de l’arbre. Puis on viens définir les différentes tâches nécéssaires dans le workflow. Quand 2 taches sont au même niveau, les tâches sont exécutées de manière concurente. Pour définir une excécution séquentielle, il faut utiliser l’option <cite>requires</cite>. Cette option définie que la tâche ne doit pas être exécutée si l’une des tâches renseignées ne se termine pas avec un succés.
L’option <cite>filters</cite> définie les différents cas de figure dans lesquels la tâche doit être exécutée.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">test_build_and_push</span><span class="p">:</span>
<span class="n">jobs</span><span class="p">:</span>
  <span class="o">-</span> <span class="n">pytest</span>
  <span class="o">-</span> <span class="n">coverage</span>
  <span class="o">-</span> <span class="n">linting</span>
  <span class="o">-</span> <span class="n">container</span><span class="p">:</span>
      <span class="n">context</span><span class="p">:</span>
        <span class="o">-</span> <span class="n">docker_hub_creds</span>
      <span class="n">requires</span><span class="p">:</span>
        <span class="o">-</span> <span class="n">pytest</span>
      <span class="n">filters</span><span class="p">:</span>
        <span class="n">branches</span><span class="p">:</span>
          <span class="n">only</span><span class="p">:</span> <span class="n">master</span>
</pre></div>
</div>
</section>
<section id="configuration-du-projet-dans-circleci">
<h3>Configuration du projet dans circleCI<a class="headerlink" href="#configuration-du-projet-dans-circleci" title="Link to this heading">¶</a></h3>
</section>
</section>
<section id="gestion-de-l-application-et-du-deploiement">
<h2>Gestion de l’application et du deploiement<a class="headerlink" href="#gestion-de-l-application-et-du-deploiement" title="Link to this heading">¶</a></h2>
<ul class="simple">
<li><p>chargement d’une image docker pour l’excecution des commandes de conteneurisation</p></li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>docker:
  - image: cimg/base:2022.09
    auth:
      username: $DOCKERHUB_USERNAME
      password: $DOCKERHUB_PASSWORD
</pre></div>
</div>
<ul class="simple">
<li><p>chargement dans les variables d’environment du hash de commit pour l’identification de l’image docker</p></li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">environment</span><span class="p">:</span>
  <span class="n">COMMIT_HASH</span><span class="p">:</span> <span class="o">&lt;&lt;</span><span class="n">pipeline</span><span class="o">.</span><span class="n">trigger_parameters</span><span class="o">.</span><span class="n">github_app</span><span class="o">.</span><span class="n">commit_sha</span><span class="o">&gt;&gt;</span>
    <span class="c1">#   username: $DOCKERHUB_USERNAME</span>
    <span class="c1">#   password: $DOCKERHUB_PASSWORD</span>
</pre></div>
</div>
<ul>
<li><p>Lancement des étapes de conteneurisation</p>
<ul class="simple">
<li><p>récupération du code source</p></li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">-</span> <span class="n">checkout</span>
</pre></div>
</div>
<ul class="simple">
<li><p>cette ligne permet l’excecution des commandes <cite>docker</cite> et <cite>docker-compose</cite> localement sur la machine</p></li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">-</span> <span class="n">setup_remote_docker</span>
</pre></div>
</div>
<ul class="simple">
<li><p>chargement d’un cache si existant</p></li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">-</span> <span class="n">restore_cache</span><span class="p">:</span>
      <span class="n">keys</span><span class="p">:</span>
        <span class="o">-</span> <span class="n">v1</span><span class="o">-</span><span class="p">{{</span> <span class="o">.</span><span class="n">Branch</span> <span class="p">}}</span>
      <span class="n">paths</span><span class="p">:</span>
        <span class="o">-</span> <span class="o">/</span><span class="n">caches</span><span class="o">/</span><span class="n">app</span><span class="o">.</span><span class="n">tar</span>
</pre></div>
</div>
<ul class="simple">
<li><p>création d’une variable <cite>TAG</cite> et utilisation de celle-ci pour l’identification de l’image. Puis, connection au repertoire docker. Enfin, on pousse l’image sur dockerhub</p></li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>name: Build and Push application Docker image
command: |
  TAG=$COMMIT_HASH
  docker build -t $DOCKERHUB_USERNAME/orange_county:$TAG -t $DOCKERHUB_USERNAME/orange_county:latest .
  echo $DOCKERHUB_PASSWORD | docker login -u $DOCKERHUB_USERNAME --password-stdin
  docker push $DOCKERHUB_USERNAME/orange_county:$TAG
</pre></div>
</div>
<ul class="simple">
<li><p>on créer un cache pour faciliter la prochaine exécution</p></li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">-</span> <span class="n">save_cache</span><span class="p">:</span>
  <span class="n">key</span><span class="p">:</span>
    <span class="o">-</span> <span class="n">v1</span><span class="o">-</span><span class="p">{{</span> <span class="o">.</span><span class="n">Branch</span> <span class="p">}}</span>
  <span class="n">paths</span><span class="p">:</span>
    <span class="o">-</span> <span class="o">/</span><span class="n">caches</span><span class="o">/</span><span class="n">app</span><span class="o">.</span><span class="n">tar</span>
</pre></div>
</div>
</li>
</ul>
</section>
</section>


          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<h1 class="logo"><a href="index.html">orange_county</a></h1>








<h3>Navigation</h3>
<p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="first_steps.html">Premiers pas</a></li>
<li class="toctree-l1"><a class="reference internal" href="use_guide.html">Guide d'utilisation</a></li>
<li class="toctree-l1"><a class="reference internal" href="data_management.html">Gestion des données</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Mise en production et maintenance</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#flux-de-travail">flux de travail</a></li>
<li class="toctree-l2"><a class="reference internal" href="#gestion-du-deploiement">Gestion du deploiement</a></li>
<li class="toctree-l2"><a class="reference internal" href="#gestion-de-l-application-et-du-deploiement">Gestion de l’application et du deploiement</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="api_description.html">Interface de programmation</a></li>
<li class="toctree-l1"><a class="reference internal" href="doc_generation.html">Contruction de la documentaion</a></li>
</ul>

<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="index.html">Documentation overview</a><ul>
      <li>Previous: <a href="data_management.html" title="Chapitre précédent">Gestion des données</a></li>
      <li>Next: <a href="api_description.html" title="Chapitre suivant">Interface de programmation</a></li>
  </ul></li>
</ul>
</div>
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Recherche rapide</h3>
    <div class="searchformwrapper">
    <form class="search" action="search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>document.getElementById('searchbox').style.display = "block"</script>








        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &#169;2024, Payssan Jonathan.
      
      |
      Powered by <a href="https://www.sphinx-doc.org/">Sphinx 7.2.6</a>
      &amp; <a href="https://alabaster.readthedocs.io">Alabaster 0.7.16</a>
      
      |
      <a href="_sources/deploy_and_management.rst.txt"
          rel="nofollow">Page source</a>
    </div>

    

    
  </body>
</html>